<main>
	<%- include('../partials/adminSidebar') %>
	
	<div id="main-wrapper">
		
		<div class="bg-white shadow-sm p-3">
			<span class="me-3" id="sidebar-toggler-btn"><i class="fas fa-bars"></i></span>
			<h5 class="m-0 color-theme d-inline-block">Donation</h5>
		</div>
		
		<div class="border m-4 my-3 p-4 bg-white rounded-2 shadow-sm">
			<div class="mb-2">
				<span>Donor Name:</span>
				<span><%= donation.donor.firstName + " " + donation.donor.lastName %></span>
			</div>
			
			<div class="mb-2">
				<span>Food type:</span>
				<span><%= donation.foodType %></span>
			</div>
			
			<div class="mb-2">
				<span>Quantity:</span>
				<span><%= donation.quantity %></span>
			</div>
			
			<div class="mb-2">
				<span>Time of cooking:</span>
				<span><%= donation.cookingTime.toLocaleString("en-IN", { dateStyle: "medium", timeStyle: "short"}) %></span>
			</div>

			<div class="mb-2">
				<span>Safe to eat until:</span>
				<span><%= donation.expiryTime ? donation.expiryTime.toLocaleString("en-IN", { dateStyle: "medium", timeStyle: "short"}) : "Not provided" %></span>
			</div>
			<% if(donation.donationPhotos && donation.donationPhotos.length) { %>
				<div class="mb-3">
					<span>Donor photos:</span>
					<div class="d-flex flex-wrap gap-2 proof-gallery mt-2">
						<% donation.donationPhotos.forEach(photo => { %>
							<a href="<%= photo %>" target="_blank"><img src="<%= photo %>" alt="Donation photo"></a>
						<% }) %>
					</div>
				</div>
			<% } %>
			
			<div class="mb-2">
				<span>Address to collect:</span>
				<span><%= donation.address %></span>
			</div>
			
			<div class="mb-2">
				<span>Phone:</span>
				<span><%= donation.phone %></span>
			</div>
			
			<% if(donation.donorToAdminMsg != "") { %>
				<div class="mb-2">
					<span>Message from Donor:</span>
					<div class="ms-3"><%= donation.donorToAdminMsg %></div>
				</div>
			<% } %>
				
			<div class="mb-2">
				<span>Status:</span>
				<span class="fw-bold text-<%= donation.status %>"><%= donation.status %></span>
			</div>

			<div class="mb-3">
				<span>Nearest NGOs notified:</span>
				<div class="table-responsive mt-2">
					<table class="table table-sm">
						<thead>
							<tr>
								<th>NGO</th>
								<th>Status</th>
								<th>Distance (km)</th>
								<th>Responded at</th>
							</tr>
						</thead>
						<tbody>
							<% if(donation.candidateAgents && donation.candidateAgents.length) { %>
								<% donation.candidateAgents.forEach(entry => { %>
									<tr>
										<td>
											<% if(entry.agent && entry.agent.firstName) { %>
												<%= entry.agent.restaurantName || (entry.agent.firstName + " " + entry.agent.lastName) %>
											<% } else { %>
												<span class="text-muted">Unknown</span>
											<% } %>
										</td>
										<td class="text-capitalize"><%= entry.status %></td>
										<td><%= entry.distanceKm || "—" %></td>
										<td><%= entry.respondedAt ? entry.respondedAt.toLocaleString("en-IN", { dateStyle: "medium", timeStyle: "short"}) : "—" %></td>
									</tr>
								<% }) %>
							<% } else { %>
								<tr>
									<td colspan="4" class="text-muted">Auto-assignment has not run yet.</td>
								</tr>
							<% } %>
						</tbody>
					</table>
				</div>
			</div>

			<% if(donation.proofs && donation.proofs.length) { %>
				<div class="mb-3">
					<span>NGO proof photos:</span>
					<div class="d-flex flex-wrap gap-2 proof-gallery mt-2">
						<% donation.proofs.forEach(photo => { %>
							<a href="<%= photo %>" target="_blank"><img src="<%= photo %>" alt="Proof photo"></a>
						<% }) %>
					</div>
					<% if(donation.proofNotes) { %>
						<div class="alert alert-info mt-3 mb-0">
							<strong>NGO note:</strong> <%= donation.proofNotes %>
						</div>
					<% } %>
				</div>
			<% } %>
			
			<% if(donation.status == "assigned" && donation.agent) { %>
				<div class="mb-2">
					<span>Agent assigned:</span>
					<span><%= donation.agent.firstName + " "  + donation.agent.lastName %></span>
				</div>
			<% } %>
			
			<% if(donation.status == "collected") { %>
				<div class="mb-2">
					<span>Collection time:</span>
					<span><%= donation.collectionTime.toLocaleString("en-IN", { dateStyle: "medium", timeStyle: "short"}) %></span>
				</div>
			<% } %>
			
			
			<% if(donation.status !== "rejected" && donation.status !== "collected") { %>
				<div class="mt-4">
					<a href="/admin/donation/reject/<%= donation._id %>" class="btn btn-danger">Reject donation</a>
				</div>
			<% } %>
			
		</div>
		
	</div>
</main>