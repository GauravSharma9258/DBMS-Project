<main>
	<%- include('../partials/agentSidebar') %>
	
	<div id="main-wrapper">
		
		<div class="bg-white shadow-sm p-3">
			<span class="me-3" id="sidebar-toggler-btn"><i class="fas fa-bars"></i></span>
			<h5 class="m-0 color-theme d-inline-block">Collection</h5>
		</div>
		
		<div class="border m-4 my-3 p-4 bg-white rounded-2 shadow-sm">
			<div class="mb-2">
				<span>Donor Name:</span>
				<span><%= collection.donor.firstName + " " + collection.donor.lastName %></span>
			</div>
			
			<div class="mb-2">
				<span>Food type:</span>
				<span><%= collection.foodType %></span>
			</div>
			
			<div class="mb-2">
				<span>Quantity:</span>
				<span><%= collection.quantity %></span>
			</div>
			
			<div class="mb-2">
				<span>Time of cooking:</span>
				<span><%= collection.cookingTime.toLocaleString("en-IN", { dateStyle: "medium", timeStyle: "short"}) %></span>
			</div>
			
			<div class="mb-2">
				<span>Safe to eat until:</span>
				<span><%= collection.expiryTime ? collection.expiryTime.toLocaleString("en-IN", { dateStyle: "medium", timeStyle: "short"}) : "Not provided" %></span>
			</div>

			<% if(collection.donationPhotos && collection.donationPhotos.length) { %>
				<div class="mb-3">
					<span>Donor photos:</span>
					<div class="d-flex flex-wrap gap-2 proof-gallery mt-2">
						<% collection.donationPhotos.forEach(photo => { %>
							<a href="<%= photo %>" target="_blank"><img src="<%= photo %>" alt="Donation photo"></a>
						<% }) %>
					</div>
				</div>
			<% } %>
			
			<div class="mb-2">
				<span>Address to collect:</span>
				<span><%= collection.address %></span>
			</div>
			
			<div class="mb-2">
				<span>Phone:</span>
				<span><%= collection.phone %></span>
			</div>
			
			<div class="mb-2">
				<span>Status:</span>
				<span class="fw-bold text-<%= collection.status %>"><%= collection.status %></span>
			</div>
			
			<% if(collection.status == "assigned" && collection.adminToAgentMsg != "") { %>
				<div class="mb-2">
					<span>Message from Admin:</span>
					<div class="ms-3"><%= collection.adminToAgentMsg %></div>
				</div>
			<% } %>
			
			<% if(collection.status == "collected") { %>
				<div class="mb-2">
					<span>Collection time:</span>
					<span><%= collection.collectionTime.toLocaleString("en-IN", { dateStyle: "medium", timeStyle: "short"}) %></span>
				</div>
			<% } %>

			<% if(collection.status !== "collected") { %>
				<hr class="my-4">
				<form action="/agent/collection/uploadProof/<%= collection._id %>" method="POST" enctype="multipart/form-data" id="proof-section">
					<h5 class="mb-3">Upload proof of donation</h5>
					<p class="text-muted mb-3">Share photos of the meals being served to the community. This builds trust with donors.</p>
					<div class="mb-3 sp-upload-zone">
						<label class="form-label d-block mb-2">Proof photos (up to 4)</label>
						<input type="file" class="form-control" name="proofPhotos" accept="image/*" multiple>
					</div>
					<div class="mb-3">
						<label class="form-label">Notes about this donation (optional)</label>
						<textarea name="proofNotes" class="form-control" rows="2" placeholder="Where was the food served? Who benefited?"></textarea>
					</div>
					<button type="submit" class="btn">Save proof & continue</button>
				</form>
			<% } else { %>
				<hr class="my-4">
				<h5>Proof provided</h5>
				<% if(collection.proofs && collection.proofs.length) { %>
					<div class="d-flex flex-wrap gap-2 proof-gallery my-2">
						<% collection.proofs.forEach(photo => { %>
							<a href="<%= photo %>" target="_blank">
								<img src="<%= photo %>" alt="Donation proof">
							</a>
						<% }) %>
					</div>
				<% } else { %>
					<p class="text-muted mb-0">No photos uploaded.</p>
				<% } %>
				<% if(collection.proofNotes) { %>
					<div class="alert alert-info mt-3">
						<strong>Notes:</strong> <%= collection.proofNotes %>
					</div>
				<% } %>
			<% } %>
			
			<% if(collection.latitude && collection.longitude) { %>
				<div class="mb-2">
					<span>Location on map:</span>
					<div id="collection-map" class="mt-2"></div>
					<small class="text-muted d-block mt-2">Use the map above for navigation. Marker is limited to India.</small>
				</div>
			<% } else { %>
				<div class="alert alert-warning mt-3 mb-0">
					This donation does not include map coordinates. Please rely on the address provided above.
				</div>
			<% } %>
			
		</div>
		
	</div>
</main>

<% if(collection.latitude && collection.longitude) { %>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
	
	<style>
		#collection-map {
			width: 100%;
			height: 300px;
			border-radius: 10px;
			border: 1px solid #e0e0e0;
		}
	</style>
	
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const lat = <%- collection.latitude %>;
			const lng = <%- collection.longitude %>;
			const map = L.map('collection-map', {
				minZoom: 4,
				maxZoom: 18,
				maxBounds: [
					[6.5546079, 68.1113787],
					[37.084107, 97.395561]
				],
				maxBoundsViscosity: 0.8
			}).setView([lat, lng], 13);
	
			L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			}).addTo(map);
	
			L.marker([lat, lng]).addTo(map).bindPopup('Pickup location').openPopup();
		});
	</script>
<% } %>