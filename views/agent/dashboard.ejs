<main>
	<%- include('../partials/agentSidebar') %>
	
	<div id="main-wrapper">
		
		<div class="bg-white shadow-sm p-3">
			<span class="me-3" id="sidebar-toggler-btn"><i class="fas fa-bars"></i></span>
			<h5 class="m-0 color-theme d-inline-block">Dashboard</h5>
		</div>
		
		<div class="d-flex gap-3 flex-wrap m-4 text-white">
			
			<div class="bg-primary rounded p-3" style="width: 300px;">
				<div class="fs-1"><%= numAssignedDonations %></div>
				<div class="fs-5">donations not collected yet</div>
			</div>
			
			<div class="bg-success rounded p-3" style="width: 300px;">
				<div class="fs-1"><%= numCollectedDonations %></div>
				<div class="fs-5">donations collected by you</div>
			</div>
			
		</div>

		<div class="m-4">
			<div class="bg-white p-4 shadow-sm rounded">
				<h5 class="mb-3">Donors around you</h5>
				<div id="agent-network-map"></div>
				<small class="text-muted d-block mt-2">Keep an eye on nearby donors to plan efficient pickups.</small>
			</div>
		</div>
		
		
	</div>
</main>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<style>
	#agent-network-map {
		width: 100%;
		height: 320px;
		border-radius: 8px;
		border: 1px solid #e0e0e0;
	}
</style>
<script>
	document.addEventListener("DOMContentLoaded", async () => {
		const map = L.map("agent-network-map").setView([20.5937, 78.9629], 5);
		L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
			attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
		}).addTo(map);

		try {
			const response = await fetch("/api/locations");
			const payload = await response.json();
			if (!payload.success) return;

			const markers = [];
			payload.donors.forEach(donor => {
				if (typeof donor.latitude !== "number" || typeof donor.longitude !== "number") return;
				const marker = L.circleMarker([donor.latitude, donor.longitude], {
					radius: 7,
					color: "#198754",
					fillColor: "#198754",
					fillOpacity: 0.8
				}).addTo(map);
				marker.bindPopup(`
					<div class="fw-semibold">${donor.restaurantName || (donor.firstName + " " + donor.lastName)}</div>
					<small>${donor.restaurantAddress || "Address unavailable"}</small><br>
					<small>${donor.phone || ""}</small>
				`);
				markers.push(marker.getLatLng());
			});

			if (markers.length) {
				const bounds = L.latLngBounds(markers);
				map.fitBounds(bounds.pad(0.15));
			}
		} catch (error) {
			console.error("Failed to load donor map", error);
		}
	});
</script>