<main>
	<%- include('../partials/donorSidebar') %>
	
	<div id="main-wrapper">
		
		<div class="bg-white shadow-sm p-3">
			<span class="me-3" id="sidebar-toggler-btn"><i class="fas fa-bars"></i></span>
			<h5 class="m-0 color-theme d-inline-block">Dashboard</h5>
		</div>
		
		<% const verificationStatus = currentUser && currentUser.verificationStatus ? currentUser.verificationStatus : 'approved'; %>
		<% if (verificationStatus !== 'approved') { %>
			<div class="alert alert-warning mx-4 mt-4">
				<strong>Status:</strong> Your restaurant verification is currently <%= verificationStatus %>.
				<a href="/donor/verification" class="ms-2">View details</a>
			</div>
		<% } %>
		
		<div class="d-flex gap-3 flex-wrap m-4 text-white">
			
			<div class="bg-success rounded p-3" style="width: 100%;">
				<div class="fs-1"><%= numCollectedDonations %></div>
				<div class="fs-5">donations by you</div>
			</div>
			
			<div class="bg-primary rounded p-3" style="width: 250px;">
				<div class="fs-1"><%= numPendingDonations %></div>
				<div class="fs-5">donations waiting for nearby NGOs</div>
			</div>
			
			<div class="bg-danger rounded p-3" style="width: 250px;">
				<div class="fs-1"><%= numAssignedDonations %></div>
				<div class="fs-5">donations not collected yet</div>
			</div>
			
		</div>

		<div class="m-4">
			<div class="bg-white p-4 shadow-sm rounded">
				<h5 class="mb-3">Verified NGOs near you</h5>
				<div id="donor-network-map"></div>
				<small class="text-muted d-block mt-2">We automatically notify the closest NGOs when you post a donation.</small>
			</div>
		</div>
		
	</div>
</main>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<style>
	#donor-network-map {
		width: 100%;
		height: 320px;
		border-radius: 8px;
		border: 1px solid #e0e0e0;
	}
</style>
<script>
	document.addEventListener("DOMContentLoaded", async () => {
		const map = L.map("donor-network-map").setView([20.5937, 78.9629], 5);
		L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
			attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
		}).addTo(map);

		try {
			const response = await fetch("/api/locations");
			const payload = await response.json();
			if (!payload.success) return;

			const markers = [];
			payload.agents.forEach(agent => {
				if (typeof agent.latitude !== "number" || typeof agent.longitude !== "number") return;
				const marker = L.circleMarker([agent.latitude, agent.longitude], {
					radius: 7,
					color: "#0d6efd",
					fillColor: "#0d6efd",
					fillOpacity: 0.8
				}).addTo(map);
				marker.bindPopup(`
					<div class="fw-semibold">${agent.restaurantName || (agent.firstName + " " + agent.lastName)}</div>
					<small>${agent.restaurantAddress || "Address unavailable"}</small><br>
					<small>${agent.restaurantPhone || ""}</small>
				`);
				markers.push(marker.getLatLng());
			});

			if (markers.length) {
				const bounds = L.latLngBounds(markers);
				map.fitBounds(bounds.pad(0.15));
			}
		} catch (error) {
			console.error("Failed to load network map", error);
		}
	});
</script>